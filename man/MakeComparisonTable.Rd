% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/MakeComparisonTable.R
\name{MakeComparisonTable}
\alias{MakeComparisonTable}
\title{Make comparison table with covariate adjustment, effect sizes, and pairwise contrasts}
\usage{
MakeComparisonTable(
  DataFrame,
  CompVariable = NULL,
  Variables,
  ...,
  Covariates = NULL,
  ValueDigits = 2,
  pDigits = 3,
  AddEffectSize = FALSE,
  EffectSizeDigits = 2,
  AddPairwise = FALSE,
  PairwiseMethod = "bonferroni",
  Parametric = TRUE,
  ParametricDisplay = NULL,
  IncludeOverallN = FALSE,
  IncludeMissing = FALSE,
  suppress_warnings = FALSE,
  Referent = NULL,
  IncludeOverallStats = FALSE,
  ShowPositiveBinaryOnLabel = TRUE,
  CatMethod = c("auto", "chisq", "fisher"),
  MultiCatAdjusted = c("multinomial_LR", "none")
)
}
\arguments{
\item{DataFrame}{A data frame.}

\item{CompVariable}{Grouping variable name (character scalar). If NULL or missing and
\code{IncludeOverallStats = TRUE}, an overall-only table is returned.}

\item{Variables}{Character vector of variables to include. You may also pass additional
variable names as unnamed arguments via \code{...} (convenience).}

\item{...}{Optional additional variable names (character scalars). Useful when you accidentally
typed \verb{Variables="A", "B"} instead of \code{Variables=c("A","B")}.}

\item{Covariates}{Optional covariate names (character vector) used for adjusted models.
Any covariates appearing in \code{Variables} are removed from the displayed table with a warning.}

\item{ValueDigits}{Digits for summary statistics (default 2).}

\item{pDigits}{Digits to display formatted p-values using \code{\link[=format.pval]{format.pval()}}.}

\item{AddEffectSize}{Add effect sizes column (default FALSE).}

\item{EffectSizeDigits}{Digits for effect sizes (default 2).}

\item{AddPairwise}{Add pairwise p-value columns (default FALSE).}

\item{PairwiseMethod}{P-adjustment method (default "bonferroni"). Use "none" for no adjustment.
Must be one of "none" or \link[stats:p.adjust]{stats::p.adjust.methods}.}

\item{Parametric}{If TRUE, use parametric tests where relevant. If FALSE and covariates are present,
robust ANCOVA is used for continuous outcomes and robust covariance is used for continuous pairwise.}

\item{ParametricDisplay}{If TRUE show mean (SD); if FALSE show median \link{IQR}. Defaults to \code{Parametric}.}

\item{IncludeOverallN}{If TRUE add overall N column.}

\item{IncludeMissing}{If TRUE include missing/unknown category rows in summaries.}

\item{suppress_warnings}{If TRUE suppress gtsummary warnings.}

\item{Referent}{Optional reference level for pairwise contrasts (character scalar). If set,
pairwise comparisons are against this referent.}

\item{IncludeOverallStats}{If TRUE return overall-only summary (ignores grouping).}

\item{ShowPositiveBinaryOnLabel}{If TRUE, display only the “positive” level for binary categorical variables.}

\item{CatMethod}{Categorical test method: "chisq", "fisher", or "auto" (default).}

\item{MultiCatAdjusted}{Adjusted multi-category method when covariates are present:
currently supports "multinomial_LR" (default) or "none".}
}
\value{
A \code{gtsummary::tbl_summary} object with added columns in \code{table_body}.
}
\description{
Create a label-friendly comparison table (via \strong{gtsummary}) summarizing variables across
groups, with optional global hypothesis tests, covariate-adjusted tests, effect sizes,
and optional pairwise comparisons.
}
\details{
This function is designed for publication tables where you want the \strong{Test} column to
reflect the method used for the reported p-value(s), while still leveraging gtsummary's
formatting, labeling, and table structure.
\subsection{Overview}{

\code{MakeComparisonTable()} is a wrapper around \code{\link[gtsummary:tbl_summary]{gtsummary::tbl_summary()}} that:
\itemize{
\item creates group-wise descriptive summaries,
\item computes global p-values (unadjusted or covariate-adjusted),
\item optionally computes effect sizes,
\item optionally computes pairwise p-values (with multiplicity control and optional referent),
\item adds a \strong{Notes} column to explain common edge cases (e.g., complete-case filtering dropping
a group level, causing missing adjusted pairwise contrasts).
}

The function aims to \strong{use gtsummary capabilities wherever possible} (summary, formatting,
styling, captioning), and only computes additional statistics not provided directly by
gtsummary (adjusted/global tests, adjusted pairwise, effect sizes).
}

\subsection{Variable typing rules}{
\itemize{
\item Continuous: numeric variables with > 2 unique non-missing values.
\item Dichotomous numeric: numeric variables with exactly 2 unique non-missing values (treated as categorical).
\item Categorical: factors, characters, logicals, and non-numeric variables (or dichotomous numeric).
}
}

\subsection{Global tests (p-values)}{

Global p-values are computed per variable, using complete-case data for the required fields.
\subsection{Continuous outcomes}{
\itemize{
\item No covariates:
\itemize{
\item \code{Parametric = TRUE}:
\itemize{
\item 2 groups: Welch t-test (\code{\link[stats:t.test]{stats::t.test()}}, unequal variances)
\item 3+ groups: one-way ANOVA (\code{\link[stats:aov]{stats::aov()}})
}
\item \code{Parametric = FALSE}:
\itemize{
\item 2 groups: Wilcoxon rank-sum (\code{\link[stats:wilcox.test]{stats::wilcox.test()}})
\item 3+ groups: Kruskal-Wallis (\code{\link[stats:kruskal.test]{stats::kruskal.test()}})
}
}
\item With covariates:
\itemize{
\item \code{Parametric = TRUE}: ANCOVA via linear model (\code{\link[stats:lm]{stats::lm()}}) with Type II test for the
grouping term (\link[car:Anova(type = 2)]{car::Anova(type = 2)}).
\item \code{Parametric = FALSE}: robust ANCOVA via \code{\link[stats:lm]{stats::lm()}} plus HC3 robust covariance
(\link[sandwich:vcovHC(type = "HC3")]{sandwich::vcovHC(type = "HC3")}) and a Wald F-test for the grouping term
(\code{\link[car:linearHypothesis]{car::linearHypothesis()}}).
}
}
}

\subsection{Categorical outcomes (unadjusted)}{
\itemize{
\item \code{CatMethod = "chisq"}: Pearson chi-squared with \code{correct = FALSE} (\code{\link[stats:chisq.test]{stats::chisq.test()}}).
\item \code{CatMethod = "fisher"}: Fisher's exact test (\code{\link[stats:fisher.test]{stats::fisher.test()}}); for RxC tables,
uses simulated p-value (B = 1e4).
\item \code{CatMethod = "auto"} (default): uses chi-squared unless expected counts are small; then Fisher.
}
}

\subsection{Categorical outcomes (adjusted; covariates present)}{
\itemize{
\item Binary outcome: logistic regression likelihood ratio test (LR) using
\link[stats:glm(family = binomial)]{stats::glm(family = binomial)} and \link[stats:drop1(test = "Chisq")]{stats::drop1(test = "Chisq")}.
\item Multi-category outcome (3+ levels): multinomial LR (default) via \code{\link[nnet:multinom]{nnet::multinom()}} and
an LR comparison of models with and without the grouping term.
Controlled by \code{MultiCatAdjusted}, which defaults to \code{"multinomial_LR"}.
}
}

}

\subsection{Pairwise comparisons}{

Pairwise columns are added when \code{AddPairwise = TRUE}.
\subsection{Which pairs are compared}{
\itemize{
\item If \code{Referent} is \code{NULL}: all pairwise group comparisons.
\item If \code{Referent} is set: all groups are compared against the referent (treatment-vs-control).
}
}

\subsection{Multiplicity control}{
\itemize{
\item \code{PairwiseMethod} defaults to \code{"bonferroni"} and may be any value in \link[stats:p.adjust]{stats::p.adjust.methods}.
\item Use \code{"none"} for no adjustment.
}
}

\subsection{Continuous outcomes}{
\itemize{
\item No covariates:
\itemize{
\item Parametric: \link[stats:pairwise.t.test(pool.sd = FALSE)]{stats::pairwise.t.test(pool.sd = FALSE)}
\item Nonparametric: \code{\link[stats:pairwise.wilcox.test]{stats::pairwise.wilcox.test()}}
}
\item With covariates:
\itemize{
\item Uses adjusted means via \code{\link[emmeans:emmeans]{emmeans::emmeans()}} on the ANCOVA model.
\item If \code{Parametric = FALSE}, the same ANCOVA model is used, but pairwise inference uses the
HC3 robust covariance matrix supplied to emmeans (so adjusted pairwise still works).
}
}
}

\subsection{Categorical outcomes}{
\itemize{
\item No covariates: pairwise chi-squared or Fisher (per \code{CatMethod}) on the 2-group subset.
\item With covariates:
\itemize{
\item Binary outcome: for each pair, fit logistic models with and without group and use LR p-value.
\item Multi-category outcome: for each pair, fit multinomial models with and without group and use LR p-value.
\item Important edge case: in a given pairwise subset, a multi-category outcome may collapse to 2 levels;
in that case, the function automatically switches to logistic LR for that pair.
}
}
}

}

\subsection{Effect sizes}{

Effect sizes are provided when \code{AddEffectSize = TRUE}.
\itemize{
\item Continuous, 2 groups, unadjusted: absolute Cohen's d (|d|) via \code{\link[effectsize:cohens_d]{effectsize::cohens_d()}}.
\item Continuous, 3+ groups, unadjusted parametric: eta-squared (η²) via \code{\link[effectsize:eta_squared]{effectsize::eta_squared()}}.
\item Continuous, adjusted: partial eta-squared (partial η²) from Type II ANOVA table.
\item Continuous, nonparametric: epsilon-squared approximation from Kruskal-Wallis.
\item Categorical: Cramer's V (uses DescTools if available; otherwise a chi-squared-based approximation).
}
}

\subsection{Captions}{

The caption is constructed to describe:
\itemize{
\item display statistic for continuous variables (mean SD vs median IQR),
\item whether covariates were used (and how continuous outcomes were tested),
\item categorical test selection (\code{CatMethod}),
\item adjusted multi-category method (\code{MultiCatAdjusted}),
\item pairwise inclusion and multiplicity control (\code{PairwiseMethod}).
}
}

\subsection{References and background}{
\itemize{
\item Agresti A. \emph{Categorical Data Analysis} (chi-squared, Fisher logic).
\item Fox J, Weisberg S. \emph{car} package docs for Type II tests and linearHypothesis.
\item Lenth RV. \emph{emmeans} package docs for estimated marginal means.
\item Long & Ervin (2000) and \emph{sandwich} docs for HC3 robust covariance guidance.
}
}
}
\examples{
\dontrun{
df <- data.frame(
  Cluster = factor(sample(0:3, 120, TRUE)),
  Age = rnorm(120, 50, 10),
  Sex = factor(sample(c("F","M"), 120, TRUE)),
  wrat3 = rnorm(120, 95, 12),
  Education_years = rnorm(120, 14, 2),
  Race = factor(sample(c("A","B","D"), 120, TRUE)),
  Hypertension = factor(sample(c("No","Yes"), 120, TRUE))
)

MakeComparisonTable(
  df, "Cluster",
  Variables = c("Education_years", "Race", "Hypertension"),
  Covariates = c("Age","Sex","wrat3"),
  AddPairwise = TRUE,
  PairwiseMethod = "none",
  Parametric = FALSE
)
}
}
